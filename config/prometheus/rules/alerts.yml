# config/prometheus/rules/alerts.yml
groups:
  - name: system_alerts
    interval: 30s
    rules:
      # High CPU usage
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
          category: system
        annotations:
          summary: "High CPU usage on {{ $labels.instance }}"
          description: "CPU usage is above 80% for 5 minutes (current: {{ $value | humanize }}%)"
          runbook_url: "https://wiki.example.com/runbooks/high-cpu"

      # Critical CPU usage
      - alert: CriticalCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 95
        for: 2m
        labels:
          severity: critical
          category: system
        annotations:
          summary: "Critical CPU usage on {{ $labels.instance }}"
          description: "CPU usage is above 95% (current: {{ $value | humanize }}%)"

      # Low disk space
      - alert: LowDiskSpace
        expr: (node_filesystem_avail_bytes{fstype!~"tmpfs|fuse.*"} / node_filesystem_size_bytes) * 100 < 10
        for: 5m
        labels:
          severity: critical
          category: storage
        annotations:
          summary: "Low disk space on {{ $labels.instance }}"
          description: "Disk space on {{ $labels.mountpoint }} is below 10% (current: {{ $value | humanize }}%)"

      # Disk will fill in 4 hours
      - alert: DiskWillFillSoon
        expr: predict_linear(node_filesystem_avail_bytes{fstype!~"tmpfs|fuse.*"}[1h], 4*3600) < 0
        for: 30m
        labels:
          severity: warning
          category: storage
        annotations:
          summary: "Disk {{ $labels.mountpoint }} will fill in ~4 hours on {{ $labels.instance }}"
          description: "Based on current usage trend, disk will be full soon"

      # High memory usage
      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 90
        for: 5m
        labels:
          severity: warning
          category: system
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Memory usage is above 90% (current: {{ $value | humanize }}%)"

      # Service down
      - alert: ServiceDown
        expr: up == 0
        for: 2m
        labels:
          severity: critical
          category: availability
        annotations:
          summary: "Service {{ $labels.job }} is down"
          description: "{{ $labels.job }} on {{ $labels.instance }} has been down for 2 minutes"

      # High load average
      - alert: HighLoadAverage
        expr: node_load15 / count(node_cpu_seconds_total{mode="idle"}) by (instance) > 2
        for: 10m
        labels:
          severity: warning
          category: system
        annotations:
          summary: "High load average on {{ $labels.instance }}"
          description: "Load average (15m) is {{ $value | humanize }} times the CPU count"

  - name: network_alerts
    interval: 30s
    rules:
      # High network errors
      - alert: HighNetworkErrors
        expr: rate(node_network_receive_errs_total[5m]) + rate(node_network_transmit_errs_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          category: network
        annotations:
          summary: "High network errors on {{ $labels.instance }}"
          description: "Network errors on {{ $labels.device }}: {{ $value | humanize }} errors/sec"

      # Site connectivity loss
      - alert: SiteConnectivityLoss
        expr: absent(up{job="client-sites"}) or up{job="client-sites"} == 0
        for: 3m
        labels:
          severity: critical
          category: connectivity
        annotations:
          summary: "Lost connectivity to client site {{ $labels.instance }}"
          description: "Cannot reach client site for 3 minutes - check VPN and network"

  - name: application_alerts
    interval: 30s
    rules:
      # ExtrusionOS service down
      - alert: ExtrusionOSDown
        expr: up{job="extrusionos"} == 0
        for: 1m
        labels:
          severity: critical
          category: application
        annotations:
          summary: "ExtrusionOS down on {{ $labels.instance }}"
          description: "ExtrusionOS service is not responding"

      # Spectre service down
      - alert: SpectreDown
        expr: up{job="spectre"} == 0
        for: 1m
        labels:
          severity: critical
          category: application
        annotations:
          summary: "Spectre down on {{ $labels.instance }}"
          description: "Spectre service is not responding"

      # High application error rate (example - requires app metrics)
      - alert: HighApplicationErrorRate
        expr: rate(app_errors_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          category: application
        annotations:
          summary: "High error rate in {{ $labels.application }}"
          description: "Error rate is {{ $value | humanize }} errors/sec"

  - name: elasticsearch_alerts
    interval: 30s
    rules:
      # Cluster health
      - alert: ElasticsearchClusterNotHealthy
        expr: elasticsearch_cluster_health_status{color="red"} == 1
        for: 5m
        labels:
          severity: critical
          category: database
        annotations:
          summary: "Elasticsearch cluster is RED"
          description: "Elasticsearch cluster health is in RED state"

      # JVM heap usage
      - alert: ElasticsearchHighHeapUsage
        expr: (elasticsearch_jvm_memory_used_bytes{area="heap"} / elasticsearch_jvm_memory_max_bytes{area="heap"}) * 100 > 90
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "High Elasticsearch JVM heap usage"
          description: "JVM heap usage is above 90% (current: {{ $value | humanize }}%)"